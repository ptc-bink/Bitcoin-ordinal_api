import { findVinInscriptionGenesis } from '../src/bitcoin/helpers';
import { TransactionVin } from '../src/bitcoin/types';
import * as bitcoin from 'bitcoinjs-lib';

describe('Bitcoin helpers', () => {
  test('decodes inscriptions from witness data', () => {
    const v1: TransactionVin = {
      txid: '2c08b6b7786b6d3250a2fabe3b130a20e3754d618e9b2aaf03915f59a18c7ecd',
      vout: 0,
      scriptSig: {
        asm: '',
        hex: '',
      },
      txinwitness: [
        'e3216c849b378a3d6d6f2fbc2e1b533a9479370b2abcb6062d07b43f1710c6b9d2494d200c331c7231e080be7ce503ae1b998053e09e589ea3fdad1d777de542',
        '20a1bf72f7e7488bc82b02a901718026d6fca8eeb547f5e71455c28e39d7b4273bac0063036f7264010109696d6167652f706e67004cd089504e470d0a1a0a0000000d4948445200000018000000180806000000e0773df8000000974944415478da63601824e03f0e9a6a86e3c283df82ff44e0c16b01d880db1b1bc018d9502c62e4590033e8f9e995700361626896906f01cc705c982a3e18fa162ccbd3016364836162e45a80e1ca4b7313b08a51c5025a04d17fbac4c1cc9a485c0652cf026c96c030488e2a16e0c354b540439a138ea962012c1868e603e4b0a6b6e158331bd52b9bfbf7efc331b52b7a5c3e201900007f26d59065727fac0000000049454e44ae42608268',
        'c1a1bf72f7e7488bc82b02a901718026d6fca8eeb547f5e71455c28e39d7b4273b',
      ],
      sequence: 4294967293,
    };
    const i1 = findVinInscriptionGenesis(v1);
    expect(i1).not.toBeUndefined();
    expect(i1?.contentType).toBe('image/png');
    expect(i1?.content).not.toBeUndefined();

    const v2: TransactionVin = {
      txid: '274bda6667e60bedede0d87f351220da4089427e6122f7d0bbd8e662b3796358',
      vout: 0,
      scriptSig: {
        asm: '',
        hex: '',
      },
      txinwitness: [
        '152b336f7b6fc69be82df72bb4653eed7e075da88c491c0ad76451fcf0514dd667702aabdeca72cea1427124fc511da6d9ffb43b7e32b908fcef169b19dfc1f6',
        '204a3ca2cf35f7902df1215f823d977df1174048b062e03a44f71c2ee736a60cc5ac0063036f7264010109696d6167652f706e67004d080289504e470d0a1a0a0000000d49484452000000640000006401030000004a2c071700000006504c5445ffffff00000055c2d37e000002ce4944415438cb95d44b6813411807f0944a13105d14b4146916c1b33d150b7d2ce45ab027295a4b0e1e4a5b4a2b4512fac8563c78509abb68051151aacda1600b4db2a1789162021e046d934dc921859addc4906c92dd9dbf21333b01c143e7f6e39bef3133ecbaceb824acb5d109d4da12b22ed2d68808a1bdb50e94b33ccd006c9ee8d624ac5b8ec4b4aa0464deed50559665a78cacc6ba1539c1044df627c18a76a8a5c668090bac4118440719600dc2a8164086a804d5ac544c84984a5aa1aa950895f7260a556861aade5fea5c559d0d304da2528131ce4ea76a958a86793a9a9437eb65d302531db51cca4c32718de86b02e8d8c13a92b7e5728e2a108031093b4d35370ff31ac80faa19d56dee59e20c8b45afdb3bc5a79f59dec373abc6974b2c2f985d18361e27584df92013d7234b32d5e07ec3ab9f3f59a6b3f487b11191483fd5e02659d7fa1a7b549280f52d898854bd22929a8c6ef628e3188bfb6d3f9520226dc8f03209782d4a84c9bd495e197d8d28bf794554c810d37e43c2b39315a683cc6a776ac95176c1368e131653b0d3dcab751e51758d08a64984e72c26c3e8058eb8aa17b80419bfdf01192a11f8b92d035412b07d5781f32a32c9dfd7a1d25b5a8599d4966150190a36744d110109b16c4b960ad12f62aaa58ed371e2f78fd9f78a2d99776aaaf2a0324165a97f52f1694c5141a94e45bf41a13ac5ce624f5a69b4e4aa92ef4ba35fe70bb4437d73a0789c7bb14d155a216e4bc8a7d86b3ed16d83d4242a0965d3ac3b6710b0928fe655c26e8228cd392316550751888e48d1f9fc5244278b59a65b01a2dbe935a69ed4e1446891c1e58ddf781b8e38ba183b34035b8e041940860b0008dfa9787c22dfe90e1ab1dc1157e0657eb8ad398fef6a5bd31edfe5ffc5748fcf6b71cd020d1eebfad0ccfbc8f5a999c7e57ee4f15d6957319add7995cedde664bb5c684e5d73d4a103a4e8c8650266962bf4e67d24c125dae3f8e73f78b6f5177fb5c56a2d73fc4b0000000049454e44ae42608268',
        'c04a3ca2cf35f7902df1215f823d977df1174048b062e03a44f71c2ee736a60cc5',
      ],
      sequence: 4294967293,
    };
    const i2 = findVinInscriptionGenesis(v2);
    expect(i2).not.toBeUndefined();
    expect(i2?.contentType).toBe('image/png');
    expect(i2?.content).not.toBeUndefined();
  });

  test('ignores tx with no inscriptions', () => {
    const vin1: TransactionVin = {
      txid: '4648dfae530fde0ec6d5d4673761e0285ca5291c52af5a1cb9188979487f08d6',
      vout: 1,
      scriptSig: {
        asm: '',
        hex: '',
      },
      txinwitness: [
        '304402206cc1e3db22e7020afc3e4d2e36f07bcfb5625d4b1d38903927b087f8948555230220201e7cbdf7f6e4bd1c1663a57849aa33e5242934c97f8c4737dfac9d40f1d8c501',
        '02f74289e5b9351ae78548f85fb6da8d6a3ea9e4ecca63d64bca7fdb8f371089a0',
      ],
      sequence: 4294967291,
    };
    const inscription = findVinInscriptionGenesis(vin1);
    expect(inscription).toBeUndefined();
  });
});
